<html>
    <head>
        <title>模版类别管理</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" type="text/css" href="../css/main.css">
        <script src="https://cn.avoscloud.com/scripts/lib/av-0.3.1.min.js"></script>
        <script src="../js/jquery.js" type="text/JavaScript"></script>


        <script type="text/JavaScript">

            $(document).ready(function(){


                AV.initialize("nph43fkarovcw0alm1bybjhw6oxkmdtohu01a71peveh5ois", "81a58eyqm1gvzn7i7gf5pv939tpe0bqfizl00v3k7snt5vc1");


                //获取数据
                var Type = AV.Object.extend("Type");
                var query = new AV.Query(Type);
                //查询条件
                // query.equalTo("playerName", "Dan Stemkoski");
                query.find({
                  success: function(results) {
                    // alert("Successfully retrieved " + results.length + " scores.");
                    // Do something with the returned AV.Object values
                    for (var i = 0; i < results.length; i++) {
                      var object = results[i];
                      var image = object.get('typeImage');
                      var imageUrl;
                        if(image != null) {
                            imageUrl = image.thumbnailURL(50, 50);
                        }else {
                            imageUrl = '';
                        }

                        //动态插入数据
                        $('<tr id="'+object.id+'"><td><input type="checkbox" id="dropid" value="'+object.id+'">&nbsp;&nbsp;'+object.id+'</td><td>'+object.get('typeName')+'</td><td><img src="'+imageUrl+'"/></td><td>'+object.createdAt.toLocaleString()+'</td><td>'+object.updatedAt.toLocaleString()+'</td></tr>').insertAfter($('#selTable tr:eq('+i+')'));

                    }
                    //隔行变色
                    $("tr:gt(0):even").addClass("even");//.css("backgroundColor","#d2d2d2");
                    //为tr绑定click事件
                    $("tr").bind("click",function(){
                        // alert("---");
                        // alert($(this).attr("id"));
                        //跳转
                        location.href = "template.html?typeId="+$(this).attr("id");

                    });
                    //鼠标焦点事件
                    $("tr").mouseover(function(){
                            $(this).addClass("over");
                        }).mouseout(function(){
                            $(this).removeClass("over");
                    });


                  },
                  error: function(error) {
                    alert("Error: " + error.code + " " + error.message);
                  }
                });


                //添加数据
                $("#add").click(function(){
                    var typename = $("#typename").val();
                    if(!typename) {//a为null 或者"" 或者0
                        alert("类别名称不能为空！");
                        return;
                    }
                    // alert(typename);

                    var fileUploadControl = $("#typeImage")[0];
                    if (fileUploadControl.files.length > 0) {
                        var file = fileUploadControl.files[0];
                        var name = typename+".jpg";
                        var avFile = new AV.File(name, file);
                        //上传图片
                        avFile.save().then(function() {
                            //上传成功与AVObject对象相关联
                            var type = new AV.Object("Type");
                            type.set("typeName", typename);
                            type.set("typeImage", avFile);
                            type.save().then(function() {
                                alert("添加成功！");
                                location.reload();
                            }, function(error) {
                                alert("添加失败!");
                            });


                        }, function(error) {
                        // The file either could not be read, or could not be saved to AV.
                        });
                    }else {
                        alert("类别图片不能为空！");
                    }
                });


                //删除数据
                $("#drop").click(function() {
                    var length = $("input:checked").length;
                    var counter = 0;

                    $("input:checked").each(function(){
                        // alert($(this).attr('value'));
                        var Type = AV.Object.extend("Type");
                        var query = new AV.Query(Type);

                        query.get($(this).attr('value'), {
                            success: function(type) {
                                type.destroy({
                                    success: function(myObject) {
                                        counter ++;
                                        if (counter == length) {
                                            alert("删除成功！");
                                            location.reload();
                                        }
                                    },
                                    error: function(myObject, error) {
                                    }
                                    });
                            },
                            error: function(object, error) {
                            }
                        });
                    });
                });

            });





            // var TestObject = AV.Object.extend("TestObject");
            // var testObject = new TestObject();
            // testObject.save({foo: "ccccc"}, {
            //     success: function(object) {
            //         alert("AVOS Cloud works!");
            //     }
            // });

        </script>

    </head>

    <body>
        <hr id="rightline"/>

        <table  id="selTable" width="95%" align="center" style="font-family: 黑体;margin-left: 30px;" cellpadding="0" cellspacing="0">
            <tr>
                <th>id</th><th>name</th><th>image</th><th>createdAt</th><th>updatedAt</th>
            </tr>
        </table>
        <br><br>
        <div id="adddiv">
            类别名称&nbsp;&nbsp;<input type="text" id="typename" name="typeName"/><br>
            类别图片&nbsp;&nbsp;<input type='file' id='typeImage'/><br>
            <button id="add">添加</button>
        </div>
        <div id="dropdiv"><button id="drop">删除</button></div>

    </body>

</html>

